<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Note</title>
	<style>
		textarea {
            		width:97%;
            		height:675px;
            		border:none;
            		outline: none;
            		padding: 5px;
            		font-size:16px;
            		font-family:inherit;
            		resize:none;
        	}
		.dvOptions {
			margin: 15px 0px 15px 0px;
		}
		.spnLabel {
			font-weight:bold;
			font-size:28px;
			padding:5px 5px 5px 5px;
			vertical-align:bottom;
		}
		.spnSpace {
			display:inline-block;
			width:83%;
		}
		select {
    			margin-bottom: 10px;
    			outline: none;
    			font-size: 16px;
			border:none;
			background: white;
			width:100%;
			text-align-last:center;
			-webkit-appearance: none;
			font-weight:bold;
		}
		::-webkit-scrollbar { 
        		display: none; 
        	}
	</style>
	<script>
		var cacheName = "notes";
		var bkpSplit = "\n<backup" + "end>\n";
		function loadNotes(currNote) {
			showChanges(false);
			caches.open(cacheName).then((cache) => {
				cache.keys().then(function(keys) {
					for(var i=ddl().length-1;i>0;i--) {
						ddl().remove(i);
					}
					keys.sort(function(a, b){return a.url.localeCompare(b.url);});
					for(var key of keys) {
						var opt = document.createElement("option");
			    			opt.value = key.url.substring(27);
    						opt.innerHTML = opt.value.replace(/%20/g, " ")
    						ddl().appendChild(opt);
					}
					ddl().value = currNote ? currNote.replace(/ /g, "%20") : ddl().value;
	  			});
			});
		}
		function loadNote() {
			showChanges(false);
			if (ddl().selectedIndex > 0) {
				caches.open(cacheName).then((cache) => {
					var key = ddl().value;
					cache.match(key).then((response) => {
						response.text().then((data) => {
							tb().value = data;
						});				
					});			
				});
			} else {
				tb().value = "";
			}
		}
		async function exportNotes(all) {
			var name = ddl().options[ddl().selectedIndex].text;
			var data = tb().value;
			if (all) {
				const cache = await caches.open(cacheName);
				const keys = await cache.keys();
				for(var key of keys) {
					var text = await (await cache.match(key)).text();
					data = (data) ? data + bkpSplit + text : text;
				}
				name = "notesBackup";
			}
			var a = document.createElement("a");
			name = prompt("Name?", name + ".txt");
			a.download = name;
      			a.innerHTML = "export";
      			a.href = window.URL.createObjectURL(new Blob([data], { type: "text/plain" }));
      			a.style.display = "none";
      			a.onclick = function (event) { document.body.removeChild(event.target); };
      			if (name) { document.body.appendChild(a);a.click(); }
		}
		function importNotes(all) {
			var fileReader = new FileReader();
		      	fileReader.onload = async function(event) {
				if (all) {
					var notes = event.target.result.split(bkpSplit);
					const cache = await caches.open(cacheName);
					for(note of notes) {					
						await cache.put(note.split("\n")[0], new Response(note));						
					}
					loadNotes(ddl().value);
				} else {
					tb().value = event.target.result;
					showChanges(true);
				}
      			};
			fileReader.readAsText(event.target.files[0], "UTF-8");
		}
		function clearNotes() {
			caches.delete(cacheName).then((cache) => {
				alert("Cleared");
			});
		}
		function showOptions() {
			var isNew = (ddl().selectedIndex == 0);
			var title = ddl().value;
			if (spn().style.color == "") {
				var op = prompt("Export/Import/Clear/Backup/Restore?");
				if (op == "e") { exportNotes(false); }
				else if (op == "i") { elm("fileImport").click(); }
				else if (op == "c") { clearNotes();	}
				else if (op == "b") { exportNotes(true); }
				else if (op == "r") { elm("fileRestore").click(); }
			} else if (tb().value != "") {
				title = isNew? tb().value.split("\n")[0] : title;
				caches.open(cacheName).then((cache) => {
					cache.put(title, new Response(tb().value)).then(() => { loadNotes(title); });
				});
			} else if (!isNew) {
				caches.open(cacheName).then((cache) => {
					cache.delete(title).then(() => { loadNotes(); });
				});
			} else {
				loadNotes();
			}
		}
		function createNote() {
			ddl().selectedIndex = 0;
			tb().value = "";
			tb().focus();
		}
		function ddl() { return elm("ddlNotes"); }
		function tb() { return elm("tbNote"); }
		function spn() { return elm("spnOptions"); }
		function elm(id) { return document.getElementById(id); }
		function showChanges(status) {
			spn().style.color = status ? "red" : "";
		}
		function setSize() {
			tb().style.height = (window.innerHeight  > 600) ? "675px" : "415px";
		}
    </script>
</head>
<body onresize="setSize();" onload="loadNotes();">
	<div id="dvOptions" class="dvOptions">
		<span id="spnOptions" class="spnLabel" onclick="showOptions();">=</span>
		<span class="spnSpace">
			<select id="ddlNotes" onchange="loadNote();"><option>Notes</option></select>
		</span>
		<span class="spnLabel" onclick="createNote();">+</span>
		<input type="file" id="fileImport" onchange="importNotes(false);" style="display:none;" />
		<input type="file" id="fileRestore" onchange="importNotes(true);" style="display:none;" />
    	</div>
	<div id="dvNote">
        	<textarea id="tbNote" onfocus="showChanges(true);"></textarea>
    	</div>
</body>
</html>
