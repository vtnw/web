<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Notes</title>
	<style>
		.spnLabel {
			font-weight:bold;
			font-size:28px;
			padding:5px;
		}
		#spnTitle {
			display:inline-block;
			padding:5px;
			line-height:10px;
			width:82%;
			font-size: 16px;
			text-align:center;
			font-weight:bold;
			text-overflow: clip;
			white-space:nowrap;
			overflow:hidden;
		}
		#dvNotes, #tbNote {
			margin: 10px 5px 0px 5px;
			height:685px;
			overflow-y:auto;
			outline:none;
		}
		.dvNote {
			margin-bottom:40px;
			text-overflow: clip;
			white-space:nowrap;
			overflow:hidden;
			width:100%;
		}
		.dvOptions {
			margin-top: 10px;
		}
		img {
			width:100%;
			display:none
		}
		::-webkit-scrollbar {
			display: none;
		}
	</style>
	<script>
		var title = "All Notes";
		var dbName = "notes";
		var dbVersion = 1;
		var storeName = "notes";
		var notesDb;
		function initDb(callback) {
			var r = indexedDB.open(dbName, dbVersion)
			r.onupgradeneeded = function(e) { e.target.result.createObjectStore(storeName,{keyPath: "id"});	}
			r.onsuccess = function(e) { notesDb = e.target.result; callback(); }
		}
		function getNotes(cb) {
			var notes = [];
			notesDb.transaction(storeName, "readwrite").objectStore(storeName)
			.openCursor(null, "prev").onsuccess = function(e) {
				var cursor = e.target.result;
				if(cursor) { notes.push(cursor.value); cursor.continue();
				} else { cb(notes); }
			};		
		}
		function loadNotes() {
			ttl().innerText = title;
			showNote(false);
			var notes = getNotes(function (notes) {
				list().innerText = "";
				list().scrollTop = 0;
				for (var n of notes) {
					var dv = document.createElement("div");
					dv.id = n.id;
					dv.className = "dvNote";
					dv.innerText = n.content.split("\n")[0];
					dv.dataset.text = n.content;
					dv.addEventListener("click", function () {
						var n = this.dataset.text;
						tb().innerText = n;
						tb().dataset.text = n;
						tb().dataset.id = this.getAttribute("id");
						ttl().innerText = n.split("\n")[0];
						showNote(true);
						tb().scrollTop = 0;
					});
					list().appendChild(dv);
				}
			});
		}
		function exportFile() {
			var exp = function(name, data) {
				var a = document.createElement("a");
				name = prompt("Name?", name);
				a.download = name;
				a.href = data;
				a.style.display = "none";
				a.onclick = function (event) { document.body.removeChild(event.target); };
				document.body.appendChild(a);
				if(name) { a.click(); }
			};
			var d = new Date();
			d = d.getFullYear() + ('0' + (d.getMonth() + 1)).slice(-2) + ('0' + d.getDate()).slice(-2)
				+ ('0' + d.getHours()).slice(-2) + ('0' + d.getMinutes()).slice(-2) + ('0' + d.getSeconds()).slice(-2);
			if(im().style.display == "block") {
				exp("IMG_" + d + ".jpg", im().src);
			} else if (ttl().innerText == title) {
				getNotes(function(notes) { exp("notes_" + d + ".txt", objUrl(JSON.stringify(notes))); });
			} else {
				exp(tb().innerText.split("\n")[0] + ".txt", objUrl(tb().innerText));
			}
		}
		function importFile() {
			var fr = new FileReader();
			fr.onload = function(e) {
				if(isImg()) {
					createNote();
					var image = new Image();
					image.onload = function() {
						var cvs = document.createElement("canvas");
						var w = image.width;
						var h = image.height;
						w = 750/h*w;
						h = 750;
						cvs.width = w;
						cvs.height = h;
						cvs.getContext("2d").drawImage(this, 0, 0, w, h);
						im().src = cvs.toDataURL("image/jpeg", 0.8);
					};
					image.src = e.target.result;
				} else if (ttl().innerText == title) {
					var notes = JSON.parse(event.target.result);
					var a = 0;
					for(var n of notes) {					
						notesDb.transaction(storeName, "readwrite").objectStore(storeName)
						.put(n).onsuccess = function () {a++;if(a == notes.length) { loadNotes(); }};
					}
				} else {
					tb().innerText = e.target.result;
				}
				show(tb(), !isImg());
				show(im(), isImg());
				fl().value = "";
			};
			if(isImg()) { fr.readAsDataURL(fl().files[0], "UTF-8");
			} else { fr.readAsText(fl().files[0], "UTF-8"); }
		}
		function clearNotes() {
			notesDb.close();
			indexedDB.deleteDatabase(dbName).onsuccess = function() { alert("Deleted"); }
		}
		function titleClicked() {
			var id = tb().dataset.id;
			if (ttl().innerText == title) {
				createNote();
			} else {console.log(tb().innerText);
				if (id != "" && tb().innerText != tb().dataset.text) {
					notesDb.transaction(storeName, "readwrite").objectStore(storeName).delete(parseInt(id));
				}
				if (tb().innerText != "" && tb().innerText != tb().dataset.text) {
					notesDb.transaction(storeName, "readwrite").objectStore(storeName)
					.put({"content":tb().innerText, "id": new Date().getTime()}).onsuccess = loadNotes();
				} else {
					loadNotes();
				}
			}
		}
		function createNote() {
			ttl().innerText = "New";
			showNote(true);
			tb().innerText = "";
			tb().dataset.id = "";
			tb().dataset.text = "";
			tb().focus();
		}
		function showNote(status) {
			show(im(), false);
			show(list(), !status);
			show(tb(), status);
		}
		function list() { return elm("dvNotes"); }
		function tb() { return elm("tbNote"); }
		function ttl() { return elm("spnTitle"); }
		function fl() { return elm("fileImport"); }
		function im() { return elm("img"); }
		function elm(id) { return document.getElementById(id); }
		function show(elm, status) { elm.style.display = status ? "block" : "none"; }
		function isImg() { return fl().files[0].type == "image/jpeg"; }
		function objUrl(d) {return window.URL.createObjectURL(new Blob([d], { type: "text/plain" })); }
		function setSize(elm) { elm.style.height = ((window.innerHeight > 600) ? 685 : 425) + "px"; }
	</script>
</head>
<body onresize="setSize(tb());setSize(list());" onload="initDb(loadNotes);">
	<div class="dvOptions">
		<span class="spnLabel" onclick="exportFile();">=</span>
		<span id="spnTitle" onclick="titleClicked();">Notes</span>
		<span class="spnLabel" onclick="fl().click();">+</span>
		<input type="file" id="fileImport" onchange="importFile();" style="display:none" />
	</div>
	<div id="dvNotes"></div>
	<div id="tbNote" contentEditable="true"></div>
	<img id="img" />
</body>
</html>
