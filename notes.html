<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Notes</title>
	<style>
		textarea {
            		width:97%;
            		height:89vh;
            		border:none;
            		outline: none;
            		padding: 5px;
            		font-size:16px;
            		font-family:inherit;
            		resize:none;
        	}
		.dvNote {
			margin-left:15px;
			height:60px;
		}
		.dvNotes {
			height:84vh;
			overflow-y:auto;
		}
		.spnLabel {
			font-weight:bold;
			font-size:28px;
			padding:5px 10px 5px 10px;
			vertical-align:bottom;
		}
		.spnShort {
			padding:5px 5px 5px 5px;
		}
		.tbSearch {
			border:1px solid #cccccc;
			border-radius:25px;
			width:83%;
			padding: 5px 10px 5px 10px;
			outline:none;
			font-size:16px;
			font-family:inherit;
		}
		.spnOptions {
			width:83%;
			display:none;
			text-align:center;
		}
		.spnPreview {
			font-style:italic;
			font-size:14px;
			margin-top:5px;
			display:inline-block;
			color:#888888;
		}
        	::-webkit-scrollbar { 
        		display: none; 
        	}
	</style>
	<script>
		var dbName = 'vtrtdb';
		var dbVersion = 1;
		var storeName = 'notes'; 
		var notesDb;
		
		function initDb(callback) {
			var indexedDB = window.indexedDB || window.webkitIndexedDB || window.mozIndexedBD || window.msIndexedDB;
 			var request = indexedDB.open(dbName, dbVersion);

			request.onupgradeneeded = function() {
    				request.result.createObjectStore(storeName,{keyPath: "id", autoIncrement: "true"}); 
 			}
			request.onsuccess = function() {
    				notesDb = request.result;
				callback();
 			}
		}
		function add(note, callback) {
			var store = notesDb.transaction(storeName, "readwrite").objectStore(storeName);
			var request = store.put({"note":note});
			request.onsuccess = function() { callback(request.result); }
		}
		function update(id, note, callback) {
			var store = notesDb.transaction(storeName, "readwrite").objectStore(storeName);
			var request = store.put({"note":note,"id": parseInt(id)});
			request.onsuccess = function() { callback(request.result); }
		}
		function remove(id, callback) {
			var store = notesDb.transaction(storeName, "readwrite").objectStore(storeName);
			var request = store.delete(parseInt(id));
			request.onsuccess = function() { callback(request.result); }
		}
		function get(id, callback) {
    			var store = notesDb.transaction(storeName, "readwrite").objectStore(storeName);
    			var request = store.get(parseInt(id)); 
    			request.onsuccess = function() { callback(request.result); } 
 		}
		function getAll(callback) {
        		var store = notesDb.transaction(storeName, "readwrite").objectStore(storeName);
        		var request = store.openCursor();
			var notes = [];
        		request.onsuccess = function(event) {				
      				var cursor = event.target.result;
          			if (cursor) {
                			notes.push(cursor.value);
                			cursor.continue();
          			}
				else {
					callback(notes);
				}
        		};   
		}
		function clear(callback) {
			var store = notesDb.transaction(storeName, "readwrite").objectStore(storeName);
    			var request = store.clear(); 
    			request.onsuccess = function() { callback(request.result); } 		
		}

		var noteId = decodeURIComponent(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + encodeURIComponent("id").replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1"));
		var mode = "edit";
		var mergeSourceId, mergeSourceNote;
		var backupEnd = "<bkp" + "end>";
		var searchMode = "";
		var isSaving = false;
		var previewLength = 40;

		function initialize() {			
			if (noteId > 0) {
				initDb(function(){get(noteId, loadNote);});
			}
			else if (noteId.length > 0) {
				initDb(function(){loadNote({ note: ""});});
			}
			else {
				initDb(function(){getAll(loadList)});
			}
		}
        	function loadNote(data) {
			document.getElementById("dvMain").style.display = "none";
			document.getElementById("tbNote").value = data.note;
		}
        	function loadList(notes) {
			document.getElementById("dvNote").style.display = "none";
			var query = document.getElementById("tbSearch").value.toLowerCase();
			var filterNotes = [];
			var title;
			for(var i=0;i<notes.length;i++){
				title = notes[i].note.split("\n")[0];
				if((searchMode != "title" || title.toLowerCase().indexOf(query) >= 0)
					&& (searchMode != "content" || notes[i].note.toLowerCase().indexOf(query) >= 0)){
					filterNotes.push({id: notes[i].id, note: notes[i].note, title: title, preview: notes[i].note.substr(title.length, previewLength)});
				}
			}
			filterNotes.sort(function(a,b){return a.title.localeCompare(b.title)})
			var dvNotes = document.getElementById("dvNotes");
			dvNotes.innerHTML = "";
			for(var i=0;i<filterNotes.length;i++){
				var dvNote = document.createElement('div');
				dvNote.className = "dvNote";
				dvNote.id = filterNotes[i].id;
				dvNote.innerHTML = filterNotes[i].title + "<br><span class='spnPreview'>" + filterNotes[i].preview + "</span>";
				dvNote.addEventListener("click", function () {
					if (mode == "edit") {
		                        	document.getElementById("tbSearch").value="";
		                        	location.href = location.href.split("?")[0] + "?id=" + this.getAttribute("id");
					}
					else if (mode == "delete" && confirm("Delete " + this.innerHTML.split("<br>")[0] + "?")) {
						remove(this.getAttribute("id"), function(){ getAll(loadList); });
					}
					else if (mode == "export") {
						get(this.getAttribute("id"), function(note){ exportToFile(note.note.split("\n")[0], note.note); });
					}
					else if (mode == "merge") {
						if(mergeSourceId) {
							get(this.getAttribute("id"), function(note) {
								var title = note.note.split("\n")[0];
								var mergedNote = note.note.replace(title, title + "\n\n" + mergeSourceNote);
								if(confirm("Merge " + mergeSourceNote.split("\n")[0] + " with " + title + "?")) {
									update(note.id, mergedNote, function() {
										remove(mergeSourceId, function() { location.reload();});	
									});
								}
							});
						} else {
							mergeSourceId = this.getAttribute("id");
							get(this.getAttribute("id"), function(note) {
								mergeSourceNote = note.note;								
							});
						}
					}
                		});
				dvNotes.appendChild(dvNote);
			}
        	}
		function createNote() {
			document.getElementById("tbSearch").value="";
			location.href = location.href.split("?")[0] +"?id=0";
		}
		function saveNote() {
			var data = document.getElementById("tbNote").value;
			if (data.length > 0 && !isSaving) {
				isSaving = true;
				if(parseInt(noteId) > 0) {
					update(noteId, data, function(){ isSaving = false; });
				} else {
					add(data, function(newId) { noteId = newId; isSaving = false; });
				}
			}
		}
		function searchNotes(mode) {
			event.preventDefault();
			if (document.getElementById("tbSearch").value != "") {
	            		searchMode = mode;	                	
			}
			else {
				searchMode = "";
			}
			getAll(loadList);
		}
		function deleteNote() {			
			mode = "delete";
			setColor("spnDelete");
		}
		function mergeNote() {
			mode = "merge";
			setColor("spnMerge");
		}
		function exportNote() {
			mode = "export";
			setColor("spnExport");
		}
		function importNote() {
			document.getElementById('fileImport').click();
		}
		function loadFile() {
			var fileReader = new FileReader();
		      	fileReader.onload = function(event) {          			
				document.getElementById("fileImport").value = "";
				add(event.target.result, function(newId){ location.href = location.href.split("?")[0] + "?id=" + newId; });				
      			};
			fileReader.readAsText(document.getElementById("fileImport").files[0], "UTF-8");
		}
		function backupNotes() {
			getAll(function(notes) {
				var data;
				for(var i=0;i<notes.length;i++){
					data = (data) ? data + backupEnd : "";
					data = data + notes[i].note;
				}
				exportToFile("notesBackup_" + getFormattedDate(), data);
				showOptions();
			});
		}
		function restoreNotes() {
			if (confirm("Restore?")) { document.getElementById('fileRestore').click(); }
		}
		function restoreFile() {
			var fileReader = new FileReader();
		      	fileReader.onload = function(event) {
          			var allData = event.target.result;
				var notes = allData.split(backupEnd);
				var addedCount = 0;
				for(var i=0;i<notes.length;i++) {
					add(notes[i], function() { 
						addedCount++; 
						if(addedCount == notes.length) {
							location.reload(); 
						}
					});
				}
				document.getElementById("fileRestore").value = "";				
      			};
			fileReader.readAsText(document.getElementById("fileRestore").files[0], "UTF-8");
		}
		function resetNotes() {
			if(confirm("Reset?")) {
				clear(function() { location.reload(); });
			}
		}
		function showOptions() {
			if(document.getElementById("spnOptions").style.display == "inline-block") {
				document.getElementById("spnOptions").style.display = "none";
				document.getElementById("tbSearch").style.display = "inline";
				mode = "edit";
				setColor(null);
			}
			else {
				document.getElementById("spnOptions").style.display = "inline-block";
				document.getElementById("tbSearch").style.display = "none";
			}
		}
		function setColor(spnId) {
			document.getElementById("spnDelete").style.color = "black";
			document.getElementById("spnExport").style.color = "black";
			document.getElementById("spnMerge").style.color = "black";
			if (spnId != null) {
				document.getElementById(spnId).style.color = "red";
			}
		}
		function exportToFile(name, data) {
			var a = document.createElement("a");
			var name = prompt("Name?", name + ".txt");
			a.download = name;
      			a.innerHTML = "export";
      			a.href = window.URL.createObjectURL(new Blob([data], { type: "text/plain" }));
      			a.style.display = "none";
      			a.onclick = function (event) { document.body.removeChild(event.target); };
      			if (name) { document.body.appendChild(a);a.click(); }
		}
		function getFormattedDate() {
            		var d = new Date();
            		d = d.getFullYear()    
				+ ('0' + (d.getMonth() + 1)).slice(-2)
                		+ ('0' + d.getDate()).slice(-2)
                		+ ('0' + d.getHours()).slice(-2)
                		+ ('0' + d.getMinutes()).slice(-2)
                		+ ('0' + d.getSeconds()).slice(-2);
            		return d;
        	}
    </script>
</head>
<body onload="initialize();">
	<div id="dvMain">
		<div>
			<span id="spnSettings" class="spnLabel spnShort" onclick="showOptions();">=</span>
			<input type="search" class="tbSearch" id="tbSearch" onkeyup="searchNotes('title');" onsearch="searchNotes('content');" autocapitalize="off" value=""/>
			<span id="spnOptions" class="spnOptions">
				<span id="spnDelete" class="spnLabel" onclick="deleteNote();">-</span>
				<span id="spnExport" class="spnLabel" onclick="exportNote();">></span>
				<span id="spnImport" class="spnLabel" onclick="importNote();"><</span>
				<span id="spnMerge" class="spnLabel" onclick="mergeNote();">#</span>
				<span id="spnBackup" class="spnLabel" onclick="backupNotes();">?</span>
				<span id="spnRestore" class="spnLabel" onclick="restoreNotes();">!</span>
				<span id="spnReset" class="spnLabel" onclick="resetNotes();">~</span>
			</span>
			<span class="spnLabel spnShort" onclick="createNote();">+</span>
			<input type="file" id="fileImport" onchange="loadFile();" style="display:none;" />
			<input type="file" id="fileRestore" onchange="restoreFile();" style="display:none;" />
			<br><br>
		</div>
		<div id="dvNotes" class="dvNotes">
		</div>
    	</div>
	<div id="dvNote">
        	<textarea id="tbNote" onkeyup="saveNote();" onpaste="saveNote();" onclick="saveNote();"></textarea>
    	</div>
</body>
</html>
