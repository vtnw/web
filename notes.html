<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Notes</title>
	<style>
		textarea {
			width:97%;
			height:685px;
			border:none;
			outline: none;
			padding: 5px;
			font-size:16px;
			font-family:inherit;
			resize:none;
		}
		#tbSearch {
			width:97%;
			border:none;
			outline: none;
			padding: 5px;
			margin-bottom:5px;
			font-size:16px;
			font-family:inherit;
		}
		.dvOptions {
			margin: 10px 0px 0px 0px;
		}
		img {
			width:100%;
		}
		.spnLabel {
			font-weight:bold;
			font-size:28px;
			padding:5px;
			vertical-align:bottom;
		}
		#spnTitle {
			display:inline-block;
			padding:5px;
			width:82%;
			font-size: 16px;
			text-align:center;
			font-weight:bold;
			text-overflow: ellipsis;
			white-space:nowrap;
			overflow:hidden;
		}
		#dvNotes {
			margin: 0px 5px 0px 5px;
			height:675px;
			overflow-y:auto;
		}
		.dvNote {
			line-height:40px;
			text-overflow: ellipsis;
			white-space:nowrap;
			overflow:hidden;
			width:100%;
		}
		::-webkit-scrollbar { 
			display: none; 
		}
	</style>
	<script>
		var title = "Notes";
		var maxLen = 50;
		var dbName = "notesdb";
		var dbVersion = 1;
		var storeName = "notes";
		var notesDb;
		
		function initDb(callback) {
			var r = indexedDB.open(dbName, dbVersion)
			r.onupgradeneeded = function(e) { e.target.result.createObjectStore(storeName,{keyPath: "id"});	}
			r.onsuccess = function(e) { notesDb = e.target.result; callback(); }
		}
		function getNotes(cb) {
			var notes = [];
			notesDb.transaction(storeName, "readwrite").objectStore(storeName)
			.openCursor(null, "prev")
			.onsuccess = function(e) {
				var cursor = e.target.result;
				if(cursor) { notes.push(cursor.value); cursor.continue();
				} else { cb(notes); }
			};		
		}
		function loadNotes(query) {
			ttl().innerText = title;
			showNote(false);
			var notes = getNotes(function (notes) {
				list().innerText = "";
				for (var n of notes) {
					if(query == null || n.content.toLowerCase().indexOf(query) >= 0) {
						var dv = document.createElement("div");
						dv.id = n.id;
						dv.className = "dvNote";
						dv.innerText = n.content.substring(0, maxLen).replace(/\n/g, " ");
						dv.dataset.content = n.content;
						dv.addEventListener("click", function () {
							tb().value = "";
							ttl().innerText = this.innerText;
							tb().value = this.getAttribute("data-content");
							tb().dataset.text = tb().value;
							tb().dataset.id = this.getAttribute("id");
							showNote(true);
						});
						list().appendChild(dv);
					}
				}
			});
		}
		function exportFile() {
			var exp = function(name, data) {
				var a = document.createElement("a");
				name = prompt("Name?", name);
				a.download = name;
				a.innerHTML = "export";
				a.href = data;
				a.style.display = "none";
				a.onclick = function (event) { document.body.removeChild(event.target); };
				if (name) { document.body.appendChild(a);a.click(); }
			};
			var d = new Date();
			d = d.getFullYear() + ('0' + (d.getMonth() + 1)).slice(-2) + ('0' + d.getDate()).slice(-2)
				+ ('0' + d.getHours()).slice(-2) + ('0' + d.getMinutes()).slice(-2) + ('0' + d.getSeconds()).slice(-2);
			if(im().style.display == "block") {
				exp("IMG_" + d + ".jpg", im().src);
			} else if (ttl().innerText == title) {
				getNotes(function(notes) { exp("notes_" + d + ".txt", objUrl(JSON.stringify(notes))); });
			} else {
				exp(tb().value.split("\n")[0] + ".txt", objUrl(tb().value));
			}
		}
		function importFile() {
			var fileReader = new FileReader();
			fileReader.onload = function(e) {
				if(isImg()) {
					createNote();
					var image = new Image();
					image.onload = function() {
						var cvs = document.createElement("canvas");
						var ctx = cvs.getContext("2d");
						var w = image.width;
						var h = image.height;
						w = 750/h*w;
						h = 750;
						cvs.width = w;
						cvs.height = h;
						ctx.drawImage(this, 0, 0, w, h);
						im().src = cvs.toDataURL("image/jpeg", 0.8);
					};
					image.src = e.target.result;
				} else if (ttl().innerText == title) {
					var notes = JSON.parse(event.target.result);
					var a = 0;
					for(var n of notes) {					
						notesDb.transaction(storeName, "readwrite").objectStore(storeName)
						.put(n).onsuccess = function () {a++;if(a == notes.length) { loadNotes(); }};
					}
				} else {
					tb().value = e.target.result;
				}
				show(tb(), !isImg());
				show(im(), isImg());
				fl().value = "";
			};
			if(isImg()) { fileReader.readAsDataURL(fl().files[0], "UTF-8");
			} else { fileReader.readAsText(fl().files[0], "UTF-8"); }
		}
		function clearNotes() {
			notesDb.close();
			indexedDB.deleteDatabase(dbName).onsuccess = function() { alert("Deleted"); }
		}
		function titleClicked() {
			var id = tb().dataset.id;
			if (ttl().innerText == title) {
				createNote();
			} else {
				if (id != "" && tb().value != tb().dataset.text) {
					notesDb.transaction(storeName, "readwrite").objectStore(storeName).delete(parseInt(id));
				}
				if (tb().value != "" && tb().value != tb().dataset.text) {
					notesDb.transaction(storeName, "readwrite").objectStore(storeName)
					.put({"content":tb().value, "id": new Date().getTime()}).onsuccess = loadNotes();
				} else {
					loadNotes();
				}
			}
		}
		function createNote() {
			ttl().innerText = "New";
			showNote(true);
			tb().value = "";
			tb().dataset.id = "";
			tb().dataset.text = "";
			tb().focus();
		}
		function list() { return elm("dvNotes"); }
		function tb() { return elm("tbNote"); }
		function ttl() { return elm("spnTitle"); }
		function fl() { return elm("fileImport"); }
		function im() { return elm("img"); }
		function elm(id) { return document.getElementById(id); }
		function show(elm, status) { elm.style.display = status ? "block" : "none"; }
		function isImg() { return fl().files[0].type == "image/jpeg"; }
		function objUrl(d) {return window.URL.createObjectURL(new Blob([d], { type: "text/plain" })); }
		function showNote(status) {
			show(im(), false);
			show(list(), !status);
			show(tb(), status);
			show(elm("tbSearch"), !status);
			if (status) { elm("tbSearch").value = ""; }
		}
		function setSize(elm, ma, mi) { elm.style.height = ((window.innerHeight > 600) ? ma : mi) + "px"; }
	</script>
</head>
<body onresize="setSize(tb(), 685, 425);setSize(list(), 675, 415);" onload="initDb(loadNotes);">
	<div class="dvOptions">
		<span class="spnLabel" onclick="exportFile();">=</span>
		<span id="spnTitle" onclick="titleClicked();">Notes</span>
		<span class="spnLabel" onclick="fl().click();">+</span>
		<input type="file" id="fileImport" onchange="importFile();" style="display:none" />
		<input type="search" id="tbSearch" onkeyup="loadNotes(this.value);" onsearch="loadNotes(this.value);this.blur();" autocapitalize="none" />
	</div>
	<div id="dvNotes"></div>
	<textarea id="tbNote"></textarea>
	<img id="img" syle="display:none" />
</body>
</html>
